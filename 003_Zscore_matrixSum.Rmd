---
title: "Z score test"
author: "Aoyue Bi, Daxing Xu"
date: "12/23/2020"
output: 
  html_document: # html_notebook, html_document
    toc: true
    toc_float:
      toc_collapsed: false
    toc_depth: 3
    number_sections: true
    theme: simplex # default, united, cerulean, journal, flatly, darkly, readable, spacelab, united, cosmo, lumen, paper, sandstone, simplex, and yeti
    highlight: haddock # default, tango, pygments, kate, monochrome, espresso, zenburn, haddock, and breezedark
    # bibliography: bibliography.json
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(eval = T,echo = F,include = T, warning = F,message = F)
# eval 代码要不要执行
# echo 代码要不要输出
# include 图要不要输出
# warning 警告要不要输出
# message 默认信息要不要输出(如bins=30)
library(tidyverse)
library(RColorBrewer)
```

## Matrix sum by row (traids) and col (taxa)

```{r}
dataFile <- c("data/004_Zscore/000_zScore.matrix.ABD.txt.gz")
dft <- read.delim(dataFile,stringsAsFactors = F)
head(dft)

### 验证BeiJing8
# dfbejing <- dft %>% filter(SlightlyOrStrongly=="Strongly",AdditiveOrDominance=="Dominance")%>%
# select("BeiJing8")
# 
# dfbejing$BeiJing8 <- as.numeric(dfbejing$BeiJing8)
#  dfbejing <- dfbejing %>%  filter(!is.na(BeiJing8),!is.nan(BeiJing8),is.finite(BeiJing8)) %>% 
#    summarise(sum=sum(BeiJing8))
# dfbejing$BeiJing8 
# sum(as.numeric(dfbejing$BeiJing8),na.rm = T)

taxaDB <- c("/Users/Aoyue/project/wheatVMapII/003_dataAnalysis/005_vcf/001_taxaList/011_taxaInfoDB/taxa_InfoDB.txt")
dftaxaDB <- read.delim(taxaDB,stringsAsFactors = F) %>% select(Taxa,fdBySubContinent)
dftaxaDB[which(dftaxaDB$Taxa == "CS-2017"),1] <- "CS.2017"
dftaxaDB[which(dftaxaDB$Taxa == "CS-2018"),1] <- "CS.2018"

dfl <- dft %>% gather(key = "Taxa", value = "Zscore",c(-1:-6),na.rm=T) %>% 
  left_join(.,dftaxaDB,by="Taxa")

dfl$Zscore <- as.numeric(dfl$Zscore)
###*************************** above the data has been converted and next we group_by and summarise

##******************************************************** by traids (n>1)
dflsum <- dfl %>% filter(is.finite(Zscore)) %>%  
  group_by(TriadsBlockID,Chr,PosStart,PosEnd,SlightlyOrStrongly,AdditiveOrDominance,fdBySubContinent) %>% 
  summarise(sum = sum(Zscore,na.rm = T),N=n()) %>%  
  filter(N>1) %>%
  filter(!fdBySubContinent=="NA",!fdBySubContinent=="IndianDwarfWheat",!fdBySubContinent=="OtherHexaploid") %>% 
  rename(GroupBySubcontinent = fdBySubContinent)

 # write.table(dflsum,file="data/004_Zscore/001_Zscore.byTraids.ABD.txt",quote=F,col.name=T,row.names=F,sep = "\t")

 ### ???????????????????????? debug cultivar 65 why not 66?
 # dfcultivar65 <- dfl %>% filter(TriadsBlockID=="T000001",SlightlyOrStrongly=="Slightly",AdditiveOrDominance=="Additive",fdBySubContinent=="Cultivar")  ## C57
 # 
 # dfC57 <- dft %>% select(1:6,C57) %>% filter(TriadsBlockID=="T000001",SlightlyOrStrongly=="Slightly",AdditiveOrDominance=="Additive")
 # 
##******************************************************** by taxa
dflsum_bytaxa <- dfl %>% filter(is.finite(Zscore)) %>%  
  filter(!fdBySubContinent=="NA",!fdBySubContinent=="IndianDwarfWheat",!fdBySubContinent=="OtherHexaploid") %>% 
  group_by(Taxa,fdBySubContinent,SlightlyOrStrongly,AdditiveOrDominance) %>% 
  summarise(sum = sum(Zscore,na.rm = T),N=n()) %>%  
  rename(GroupBySubcontinent = fdBySubContinent)

 # write.table(dflsum_bytaxa,file="data/004_Zscore/002_Zscore.byTaxa.ABD.txt",quote=F,col.name=T,row.names=F,sep = "\t") 

```

## By taxa 验证BeiJing8

-   Conclusion: R can not recognize thousandths

```{r}
dataFile <- c("data/004_Zscore/000_zScore.matrix.ABD.txt.gz")
dft <- read.delim(dataFile,stringsAsFactors = F)
head(dft)

### 验证BeiJing8
dfbejing <- dft %>% filter(SlightlyOrStrongly=="Strongly",AdditiveOrDominance=="Dominance")%>%
select("BeiJing8") %>% mutate(row=rep(1:nrow(.)))

dfbejing[4229,1]

# dfbejing$BeiJing8 <- as.numeric(dfbejing$BeiJing8)

# write.table(dfbejing,file="/Users/Aoyue/Documents/value2.txt",quote=F,col.name=T,row.names=F,sep = "\t") 

## check na
 dfbejing_na <- dfbejing %>% 
   mutate(row=rep(1:nrow(.))) %>% 
   filter(is.na(BeiJing8))
# write.table(dfbejing_na,file="/Users/Aoyue/Documents/value3.txt",quote=F,col.name=T,row.names=F,sep = "\t") 


 dfbejing_nan <- dfbejing %>% 
   mutate(row=rep(1:nrow(.))) %>% 
   filter(is.nan(BeiJing8))
# write.table(dfbejing_nan,file="/Users/Aoyue/Documents/value4.txt",quote=F,col.name=T,row.names=F,sep = "\t") 

df_NA <- anti_join(dfbejing_na,dfbejing_nan,by="row")
# write.table(df_NA,file="/Users/Aoyue/Documents/value5.txt",quote=F,col.name=T,row.names=F,sep = "\t") 

```

## Important gene Zscore distribution

-   1.Get Rht gene triads and plot distribution
-   2.Find the outlier individuals
-   3.Use these indivi to plotting whole-genome Zscore distribution

```{r}
### step1: import data
dataFile <- c("data/004_Zscore/000_zScore.matrix.ABD.txt.gz")
dft <- read.delim(dataFile,stringsAsFactors = F)

dfgene <- read.delim("data/003_geneDB/GeneList.addTriadsID.txt",stringsAsFactors = F)
rht <- dfgene %>% filter(Unique_Name=="Rht-A1") 

### step2: find the triads 
dftsample <- dft %>% select(TriadsBlockID,Chr,PosStart,PosEnd) %>% 
   distinct(., TriadsBlockID, .keep_all = TRUE) %>% 
  filter(Chr=="4A",PosStart>rht$Start -1500000,PosEnd<rht$End+1500000) 

##***** the resut is T010295(Rht)

### step3: distribution

taxaDB <- c("/Users/Aoyue/project/wheatVMapII/003_dataAnalysis/005_vcf/001_taxaList/011_taxaInfoDB/taxa_InfoDB.txt")
dftaxaDB <- read.delim(taxaDB,stringsAsFactors = F) %>% 
  select(Taxa,fdBySubContinent) %>% 
  rename(GroupBySubcontinent= fdBySubContinent)

dftaxaDB[which(dftaxaDB$Taxa == "CS-2017"),1] <- "CS.2017"
dftaxaDB[which(dftaxaDB$Taxa == "CS-2018"),1] <- "CS.2018"

###******** Find the triads T010295
dfrhtZscore <- dft %>% filter(TriadsBlockID=="T010295") %>% 
  gather(key = "Taxa",value = "Zscore",-1:-6) %>% 
  left_join(.,dftaxaDB,by="Taxa") %>% 
  filter(!GroupBySubcontinent=="NA",!GroupBySubcontinent=="IndianDwarfWheat",!GroupBySubcontinent=="OtherHexaploid") 
  

######### *********************** plot1: not ci
p <- ggplot(dfrhtZscore,aes(x=as.numeric(Zscore),color=SlightlyOrStrongly))+
  geom_histogram(bins = 50)+
  labs(x=expression(paste(italic(Z),"-score",sep = "")),y="Density")+
  ggtitle(expression(paste(italic(Rht))))+
  #geom_vline(xintercept = vertical.lines)+
  scale_color_brewer(palette = "Set2")+
  scale_fill_brewer(palette = "Set2")+
  facet_grid(AdditiveOrDominance~SlightlyOrStrongly)+
  theme_minimal()+
  theme(text = element_text(size = 7),legend.position = "none")
p
ggsave(p,filename = "/Users/Aoyue/Documents/test.png",height = 2.57,width = 3.43)


######### *********************** plot1: add ci group
### : 计算分组下的95% 区间并添加分组信息
### 根据输入的数据框，返回置信区间分组信息
aoAddCi <- function(dfinput){
  low = quantile(dfinput$Zscore, probs = 0.025,na.rm = T)
  high = quantile(dfinput$Zscore, probs = 0.975,na.rm=T)
  dfout <- dfinput %>% 
    mutate(GroupByCI=ifelse(Zscore>high | Zscore < low,"tail","bulk") )
  return(dfout)
}

# aoAddCi <- function(dfinput){
#   low = quantile(dfinput$Zscore, probs = 0.05,na.rm = T)
#   high = quantile(dfinput$Zscore, probs = 0.95,na.rm=T)
#   dfout <- dfinput %>% 
#     mutate(GroupByCI=ifelse(Zscore>high | Zscore < low,"tail","bulk") )
#   return(dfout)
# }

dfrhtZscore$Zscore <- as.numeric(dfrhtZscore$Zscore)
dfrhtZscore$SlightlyOrStrongly <-  as.factor(dfrhtZscore$SlightlyOrStrongly)
dfrhtZscore$AdditiveOrDominance <- as.factor(dfrhtZscore$AdditiveOrDominance)
dfrhtZscore_addCI <- dfrhtZscore %>% 
  group_by(SlightlyOrStrongly, AdditiveOrDominance) %>%
  group_modify(~{.x %>% aoAddCi()})  

p <- ggplot(dfrhtZscore_addCI,aes(x=as.numeric(Zscore),fill=GroupByCI))+
  geom_histogram(bins = 50)+
  labs(x=expression(paste(italic(Z),"-score",sep = "")),y="Density")+
  ggtitle(expression(paste(italic(Rht))))+
  #geom_vline(xintercept = vertical.lines)+
  scale_color_brewer(palette = "Set2")+
  scale_fill_brewer(palette = "Set2")+
  facet_grid(AdditiveOrDominance~SlightlyOrStrongly)+
  theme(
    strip.background = element_blank(),
    panel.background = element_blank(),
    panel.border = element_rect(colour = "black", fill=NA, size=0.4),
    text = element_text(size = 7),legend.position = 'none')
p

ggsave(p,filename = "/Users/Aoyue/Documents/test.png",height = 2.57,width = 3.43)


#################### output outlier indivi #################

individuals <- c("CS.2017","C9","C22","YangMai","ZangDong4","PI345409")


dfoutlier <- dfrhtZscore_addCI %>% 
  filter(GroupByCI=="tail",Zscore>0) 
  
    # spread(.,key = AdditiveOrDominance,value = Zscore,fill = "NA") %>% 
  # filter(Taxa %in% individuals )


```

### Correlation between additive and dominance

- Conclusion: 1. In *Rht* gene, there is positive correlation between additive and dominance model.

```{r}

### plot scatter plot to check the coorelation between additive and dominance on slightly and strongly load

dfoutlier$Additive <- as.numeric(dfoutlier$Additive)
dfoutlier$Dominance <- as.numeric(dfoutlier$Dominance)
library(ggpubr)
p <-   ggplot(dfoutlier,aes(x=Additive,y=Dominance))+
  geom_point(aes(fill=SlightlyOrStrongly),alpha=0.5,shape=21)+
  stat_smooth(method = "lm", formula = y ~ x, se = T)+
  stat_cor(
    aes(label = paste(..rr.label.., ..p.label.., sep = "~`,`~")), 
    label.x.npc = c(0.15,0.15) ,label.y.npc =c(0.15,0.45),size= 2
  )+
    stat_regline_equation(label.x.npc = c(0.15,0.15),label.y.npc = c(0.2,0.5),size= 2)+
  facet_grid(.~SlightlyOrStrongly)+
  theme_bw()+
  theme(
    strip.background = element_blank(),
    legend.position = "none",text = element_text(size=7))
p
ggsave(p,filename = "/Users/Aoyue/Documents/test.png",height = 2.57,width = 3.43)
```


### Find the strongly dominance model outlier
- Conclusion: There is really no outlier at left tail

```{r}
aoAddCi <- function(dfinput){
  low = quantile(dfinput$Zscore, probs = 0.025,na.rm = T)
  high = quantile(dfinput$Zscore, probs = 0.975,na.rm=T)
  dfout <- dfinput %>% 
    mutate(GroupByCI=ifelse(Zscore>high | Zscore < low,"tail","bulk") )
  return(dfout)
}

df_stronglyDominance <- dfrhtZscore %>% filter(dfrhtZscore$SlightlyOrStrongly=="Strongly",AdditiveOrDominance=="Dominance") %>% 
  aoAddCi(.) 
  

p <- ggplot(df_stronglyDominance,aes(x=]\]\[pppppppp]\p[as.numeric(Zscore),fill=GroupByCI))+
  geom_histogram(bins = 50)+
  labs(x=expression(paste(italic(Z),"-score",sep = "")),y="Density")+
  #geom_vline(xintercept = vertical.lines)+
  scale_color_brewer(palette = "Set2")+
  scale_fill_brewer(palette = "Set2")+
  theme_minimal()+
  theme(text = element_text(size = 7),legend.position = "none")
p
ggsave(p,filename = "/Users/Aoyue/Documents/test.png",height = 2.57,width = 3.43)

```


## Z score distribution on the whole genome

-   1.Two individual strongly under one model (dominance)

-   2.Plot on whole-genome by chr and use window scan method  

```{r}
### step1: import data
dataFile <- c("data/004_Zscore/000_zScore.matrix.ABD.txt.gz")
# dft <- read.delim(dataFile,stringsAsFactors = F)
### sample indiviuals
individuals <- c("CS.2017","C9","C22","YangMai","ZangDong4","PI345409","PI162002")
df_noslide <-  dft %>% select(1:6,all_of(individuals)) %>% 
  gather(key = "Taxa",value = "Zscore",-1:-6)

############################ plot no sliding window #################################
factor1 <- c("Slightly","Strongly")
factor2 <- c("Additive","Dominance")
for(i in factor1){
  for (j in factor2) {
    data <- data.frame(Chr = c("1A","2A","3A","4A","5A","6A","7A"),x=c(213,327,319,266,254,286,362),y=rep(0,7))
    
p <- df_noslide %>% filter(SlightlyOrStrongly==i,AdditiveOrDominance==j) %>%  
  ggplot(aes(x= PosStart/1000000,y = Zscore,color=Taxa))+
  geom_line()+
  facet_grid(Chr~.)+
  geom_point(aes(x,y),color = "blue",size=2,data = data)+
  scale_color_brewer(palette = "Set2")+
  labs(x="Physical position (M)", y = expression(paste(italic(Z),"-score",sep = "")),
       title = paste(i,"_",j,sep = ""))+
  theme_minimal()+
  # coord_cartesian(xlim = c(581,583),ylim=c(-20,50))+
  theme(strip.background = element_blank())

p

fileS <- paste("/Users/Aoyue/Documents/",i,"_",j,".png",sep = "")
ggsave(p,filename = fileS,height = 9/2,width = 16/2)

  }
}

############################ plot sliding window #################################

### step2: custom function and use it in pipeline
aoWindowscan <- function(dfinput){
  library(windowscanr)
  pos_win <- winScan(x = dfinput,
                   groups = "Chr",
                   position = "PosStart",
                   values = c("Zscore"),
                   win_size = 10000000, #20M
                   win_step = 1000000, #10M
                   funs = c("mean", "sd","sum"))
  return(pos_win)
}

df_slide <- df_noslide %>% 
  filter(is.finite(Zscore),!is.na(Zscore)) %>% 
  group_by(Taxa,SlightlyOrStrongly,AdditiveOrDominance) %>% 
    group_modify(~{.x %>% aoWindowscan()})  %>% 
  rename(PosStart = win_start)

write.table(df_slide,file="/Users/Aoyue/Documents/10M_1M_slide.txt",quote=F,col.name=T,row.names=F,sep = "\t") 

factor1 <- c("Slightly","Strongly")
factor2 <- c("Additive","Dominance")
for(i in factor1){
  for (j in factor2) {
    data <- data.frame(Chr = c("1A","2A","3A","4A","5A","6A","7A"),x=c(213,327,319,266,254,286,362),y=rep(0,7))
    
p <- df_slide %>% filter(SlightlyOrStrongly==i,AdditiveOrDominance==j) %>%  
  ggplot(aes(x= PosStart/1000000,y = Zscore_sum,color=Taxa))+
  geom_line()+
  facet_grid(Chr~.)+
  geom_point(aes(x,y),color = "blue",size=2,data = data)+
  scale_color_brewer(palette = "Set2")+
  labs(x="Physical position (M)", y = expression(paste(italic(Z),"-score",sep = "")),
       title = paste(i,"_",j,sep = ""))+
  theme_minimal()+
  # coord_cartesian(xlim = c(581,583),ylim=c(-20,50))+
  theme(strip.background = element_blank())

p

fileS <- paste("/Users/Aoyue/Documents/",i,"_",j,".png",sep = "")
ggsave(p,filename = fileS,height = 9/2,width = 16/2)

  }
}


### look only one individual

############################ plot no sliding window #################################
factor1 <- c("Slightly","Strongly")
factor2 <- c("Additive","Dominance")
for(i in factor1){
  for (j in factor2) {
    data <- data.frame(Chr = c("1A","2A","3A","4A","5A","6A","7A"),x=c(213,327,319,266,254,286,362),y=rep(0,7))
    
p <- df_noslide %>% filter(SlightlyOrStrongly==i,AdditiveOrDominance==j) %>% 
  filter(Taxa=="C9") %>% 
  ggplot(aes(x= PosStart/1000000,y = Zscore,color=Taxa))+
  geom_line()+
  facet_grid(Chr~.)+
  geom_point(aes(x,y),color = "blue",size=2,data = data)+
  scale_color_brewer(palette = "Set2")+
  labs(x="Physical position (M)", y = expression(paste(italic(Z),"-score",sep = "")),
       title = paste(i,"_",j,sep = ""))+
  theme_minimal()+
  # coord_cartesian(xlim = c(581,583),ylim=c(-20,50))+
  theme(strip.background = element_blank())

p

fileS <- paste("/Users/Aoyue/Documents/",i,"_",j,".png",sep = "")
ggsave(p,filename = fileS,height = 9/2,width = 16/2)

  }
}

############################ plot sliding window #################################

# df_slide <- read.delim("data/004_Zscore/003_20M_10M_slide.txt",stringsAsFactors = F)
df_slide <- read.delim("data/004_Zscore/003_10M_1M_slide.txt",stringsAsFactors = F)
factor1 <- c("Slightly","Strongly")
factor2 <- c("Additive","Dominance")
for(i in factor1){
  for (j in factor2) {
    data <- data.frame(Chr = c("1A","2A","3A","4A","5A","6A","7A"),x=c(213,327,319,266,254,286,362),y=rep(0,7))
    
p <- df_slide %>% filter(SlightlyOrStrongly==i,AdditiveOrDominance==j) %>%
    filter(Taxa=="C9") %>% 
  ggplot(aes(x= PosStart/1000000,y = Zscore_sum,color=Taxa))+
  geom_line()+
  facet_grid(Chr~.)+
  geom_point(aes(x,y),color = "blue",size=2,data = data)+
  scale_color_brewer(palette = "Set2")+
  labs(x="Physical position (M)", y = expression(paste(italic(Z),"-score",sep = "")),
       title = paste(i,"_",j,sep = ""))+
  theme_minimal()+
  # coord_cartesian(xlim = c(581,583),ylim=c(-20,50))+
  theme(strip.background = element_blank())

p

fileS <- paste("/Users/Aoyue/Documents/",i,"_",j,".png",sep = "")
ggsave(p,filename = fileS,height = 9/2,width = 16/2)

  }
}

```

## Correlation between recombination and Z-score

- From individual levels
```{r}
dfrecombination <- read.delim("data/005_recombination/001_TriadsRecombiantion.txt") %>% 
  rename(TriadsBlockID=TriadID,ChrbyRecom=Chr)
dftest <- left_join(df_noslide,dfrecombination,by="TriadsBlockID") %>% mutate(ChrbyRecom=str_sub(ChrbyRecom,2,2))


factor1 <- c("Slightly","Strongly")
factor2 <- c("Additive","Dominance")
factor3 <- c("A","B","D")
factor4 <- c("CS.2017","C9","C22","YangMai","ZangDong4","PI345409","PI162002")

for(i in factor3){
  for(j in factor4){
    
    aoTitle <- paste(j,"_",i,sep="")
    p <- dftest  %>% 
  filter(Taxa== j,ChrbyRecom==i) %>% 
  # sample_n(15000) %>%
  ggplot(aes(x= RecombinationRate,y = log10(Zscore) ,fill=SlightlyOrStrongly))+
  geom_point(alpha=0.2,shape=21)+
  stat_smooth(method = "lm", formula = y ~ x, se = T,color="gray")+
  stat_cor(
    aes(label = paste(..rr.label.., ..p.label.., sep = "~`,`~")), 
    label.x.npc = c(0.15,0.15) ,label.y.npc =c(0.15,0.45),size= 2
  )+
    stat_regline_equation(label.x.npc = c(0.15,0.15),label.y.npc = c(0.2,0.5),size= 2)+
  
  facet_grid(AdditiveOrDominance~SlightlyOrStrongly)+
  scale_color_brewer(palette = "Set2")+
  labs(x="Recombination rate", y = expression(paste(italic(Z),"-score",sep = "")),
       title = aoTitle)+
  theme_minimal()+
  # coord_cartesian(xlim = c(581,583),ylim=c(-20,50))+
  theme(strip.background = element_blank(),legend.position = "none")

p

fileS <- paste("/Users/Aoyue/Documents/",j,"_",i,"_recombinationVSzscore.png",sep = "")
ggsave(p,filename = fileS,height = 9/3,width = 16/3)
    
  }
}


### 单个测试
p <- dftest  %>% 
  filter(Taxa=="C9",ChrbyRecom=="A") %>% 
  # sample_n(15000) %>%
  ggplot(aes(x= RecombinationRate,y = log10(Zscore) ,fill=SlightlyOrStrongly))+
  geom_point(alpha=0.2,shape=21)+
  stat_smooth(method = "lm", formula = y ~ x, se = T,color="gray")+
  stat_cor(
    aes(label = paste(..rr.label.., ..p.label.., sep = "~`,`~")), 
    label.x.npc = c(0.15,0.15) ,label.y.npc =c(0.15,0.45),size= 2
  )+
    stat_regline_equation(label.x.npc = c(0.15,0.15),label.y.npc = c(0.2,0.5),size= 2)+
  
  facet_grid(AdditiveOrDominance~SlightlyOrStrongly)+
  scale_color_brewer(palette = "Set2")+
  labs(x="Recombination rate", y = expression(paste(italic(Z),"-score",sep = ""))
       )+
  theme_minimal()+
  # coord_cartesian(xlim = c(581,583),ylim=c(-20,50))+
  theme(strip.background = element_blank(),legend.position = "none")

p


```


```{python}
print(1+9)
```


